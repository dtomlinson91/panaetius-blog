version: 2.1

orbs:
  node: circleci/node@3.0.1
  hugo: circleci/hugo@0.5.2
  awss3: circleci/aws-s3@1.0.16

workflows:
  initial:
    jobs:
      # - print_workspace
      - checkout_project
      - build_blog:
          requires:
            - checkout_project

jobs:
  checkout_project:
    working_directory: "~/panaetius-blog/blog"
    docker:
      - image: "circleci/python:3.8.3"
    steps:
      - checkout:
          path: "~/panaetius-blog"
      - run: git submodule update --init --recursive
      - awss3/sync:
          from: "s3://prod-panaetius-blog-static-assets/"
          to: "."
      - persist_to_workspace:
          root: "."
          paths:
            - "."

  build_blog:
    working_directory: "~/panaetius-blog/blog"
    executor:
      name: node/default
      tag: "14.3.0"
    steps:
      - attach_workspace:
          at: "."
      - node/install-packages:
          app-dir: "."
          cache-path: "./node_modules"
          pkg-manager: yarn
      - node/install-packages:
          app-dir: "./themes/panaetius-theme"
          cache-path: "./themes/panaetius-theme/node_modules"
          pkg-manager: yarn
      - hugo/install:
          version: "0.69.2"
      - run: yarn buildBlog
      - hugo/html-proofer:
          path: "./public"
          url-swap: "'https?:\/\/(panaetius.io):'"
